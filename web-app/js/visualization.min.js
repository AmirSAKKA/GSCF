var visualization=null;var currType=null;var currAggr=null;jQuery.expr[":"].Contains=function(c,d,b){return jQuery(c).text().toUpperCase().indexOf(b[3].toUpperCase())>=0};$(document).ready(function(){$("#dialog_messages, #dialog_advanced_settings").dialog({autoOpen:false,modal:true,resizable:false,show:"slide",hide:"slide",zIndex:10002,buttons:{Ok:function(){$(this).dialog("close")}}});$("#select_study").combobox();$("#select_rows").combobox();$("#select_columns").combobox();$("#select_groups").combobox();$(".ui-autocomplete-input").click(function(){$(this).blur();$(this).autocomplete("search","");$(this).focus()});$.jqplot.config.enablePlugins=true});function changeStudy(){$("#select_rows, #select_columns, #select_groups").empty();$("#select_rows, #select_columns, #select_groups").next().val("");if(visualization){visualization.destroy()}if($("#select_study").find("option:selected").length>0){$("#select_rows, #select_columns, #select_groups").parents(".menu_header").find("img.spinner").show();executeAjaxCall("getFields","menu_study",{errorMessage:"An error occurred while retrieving variables from the server. Please try again or contact a system administrator.",success:function(e,f,d){if(e.infoMessage){showError(e.infoMessage,"message_warning")}if(e.returnData&&e.returnData.studyIds==$("#select_study option:selected").val()){var c=e.returnData.fields;var a="";var b="<option value=''>Select One...</option>";$.each(c,function(g,h){if(h.category!=a){if(a.length>0){b+="</optgroup>"}b+="<optgroup label='"+h.source+": "+h.category+"' onClick='return false;'>";a=h.category}b+="<option value='"+h.id+"'>"+h.name+"</option>"});if(b.length>0){b+="</optgroup>";$("#select_rows, #select_columns, #select_groups").html(b)}else{$("#visualization").html('<div style="padding: 30px">No fields could be found. This visualization prototype requires studies with samples.</div>')}$("#select_study").parents(".menu_header").find(".menu_header_count").switchClass("menu_fill","menu_done",1000);$("#select_rows, #select_columns, #select_groups").parents(".menu_header").find("img.spinner").hide();$("#select_rows, #select_columns, #select_groups").parents(".menu_header").find(".menu_header_count").addClass("menu_fill")}}})}}function changeFields(a){$("#"+a).parents(".menu_header").find(".menu_header_count").switchClass("menu_fill","menu_done",1000);if($("#select_rows").find("option:selected").val().length>0&&$("#select_columns").find("option:selected").val().length>0){$("#select_types, #select_aggregation").parents(".menu_header").find("img.spinner").show();executeAjaxCall("getVisualizationTypes",a,{errorMessage:"An error occurred while retrieving visualization types from the server. Please try again or contact a system administrator.",success:function(e,f,d){if(e.infoMessage!=null){showError(e.infoMessage,"message_warning")}if(e.returnData&&e.returnData.rowIds==$("#select_rows option:selected").val()&&e.returnData.columnIds==$("#select_columns option:selected").val()){var c=e.returnData.types;var b=e.returnData.aggregations;if(currAggr==null){currAggr="average"}else{currAggr=$("#select_aggregation input:checked").val()}currType=$("#select_types input:checked").val();$("#select_types, #select_aggregation").parents(".menu_header").find(".menu_header_count").addClass("menu_fill");$("#select_aggregation input, #select_types input").each(function(g){$(this).attr("disabled","disabled")});$.each(c,function(g,h){$("#vis_"+h.id).attr("disabled",false);if(h.id==currType||c.length==1){currType=h.id;$("#vis_"+h.id).attr("checked","checked");$("#select_types").parents(".menu_header").find(".menu_header_count").switchClass("menu_fill","menu_done",1000)}});$.each(b,function(g,h){if(!h.disabled){$("#aggr_"+h.id).attr("disabled",false)}if(h.id==currAggr||b.length==1){currAggr=h.id;$("#aggr_"+h.id).attr("checked","checked");$("#select_aggregation").parents(".menu_header").find(".menu_header_count").switchClass("menu_fill","menu_done",1000)}});changeVis()}$("#select_types, #select_aggregation").parents(".menu_header").find("img.spinner").hide()}})}}function changeRadio(a){if($(a).attr("name")=="aggregation"){$("#select_aggregation").parents(".menu_header").find(".menu_header_count").switchClass("menu_fill","menu_done",1000);currAggr=$(a).val();if(currAggr!="none"){$("#vis_boxplot").attr("disabled","disabled");if(currType=="boxplot"){$("#vis_boxplot").attr("checked",false)}}else{$("#vis_boxplot").attr("disabled",false)}}else{$("#select_types").parents(".menu_header").find(".menu_header_count").switchClass("menu_fill","menu_done",1000);currType=$(a).val();if($(a).val()=="boxplot"){$("#select_aggregation input[value=none]").attr("checked","checked");$("#select_aggregation").parents(".menu_header").find(".menu_header_count").switchClass("menu_fill","menu_done",1000);currAggr="none"}}changeVis()}function changeVis(){if($("#autovis").attr("checked")=="checked"){visualize()}}function visualize(){if($("#select_rows").val()&&$("#select_columns").val()&&$("#select_types input:checked").length>0&&$("#select_aggregation input:checked").length>0){$("#menu_go").find(".spinner").show();executeAjaxCall("getData","menu_go",{errorMessage:"An error occurred while retrieving data from the server. Please try again or contact a system administrator.",success:function(f,b,m){if(visualization){visualization.destroy()}if(f.infoMessage!=null){showError(f.infoMessage,"message_warning")}if(!checkCorrectData(f.returnData)&&f.returnData.type!="boxplot"){showError(["Unfortunately the server returned data in a format that we did not expect."],"message_error");return}var n=new Array();var g=[];var e=f.returnData;$.each(e.series,function(t,w){if(w.y&&w.y.length>0){if(e.type=="horizontal_barchart"){var x=new Array();for(var v=0;v<w.y.length;v++){x[x.length]=new Array(w.y[v],v+1)}n[n.length]=x}else{if(e.type=="boxplot"){var u=w.y;u=[u[0],u[4],u[1],u[2],u[3],u[4],u[5],u[6],u[7]];n[n.length]=u}else{n[n.length]=w.y}}g[g.length]={label:w.name}}});if(n.length==0){showError(["Unfortunately the server returned data without any measurements"],"message_error");$("#menu_go").find(".spinner").hide();return}var h=e.xaxis.unit==""?e.xaxis.title:e.xaxis.title+" ("+e.xaxis.unit+")";var o=e.yaxis.unit==""?e.yaxis.title:e.yaxis.title+" ("+e.yaxis.unit+")";var c="";if(e.groupaxis!==undefined){c=e.groupaxis.unit==""?e.groupaxis.title:e.groupaxis.title+" ("+e.groupaxis.unit+")"}var p=null;var d=$("#showvalues").attr("checked")=="checked";var r=e.series.length>1;var l=$("#legendplacement").attr("checked")=="checked"&&r?"outsideGrid":"insideGrid";var a=$("#anglelabels").attr("checked")=="checked"?-45:0;switch(e.type){case"scatterplot":$.each(e.series,function(t,u){g[t].showLine=false;g[t].markerOptions={size:7,style:"filledCircle"}});case"linechart":p={stackSeries:false,seriesDefaults:{renderer:$.jqplot.LineRenderer,pointLabels:{show:d}},series:g,highlighter:{show:!d,sizeAdjust:7.5,tooltipAxes:"y"},legend:{show:r,placement:l},axes:{xaxis:{renderer:$.jqplot.CategoryAxisRenderer,ticks:e.series[0].x,labelRenderer:$.jqplot.CanvasAxisLabelRenderer,label:h,tickRenderer:$.jqplot.CanvasAxisTickRenderer,tickOptions:{angle:a}},yaxis:{label:o,labelRenderer:$.jqplot.CanvasAxisLabelRenderer,formatString:"%.2f"}},axesDefaults:{pad:1.4}};break;case"horizontal_barchart":p={stackSeries:false,seriesDefaults:{renderer:$.jqplot.BarRenderer,rendererOptions:{barMargin:30,highlightMouseDown:true,barDirection:"horizontal"},pointLabels:{show:d}},highlighter:{show:!d,sizeAdjust:7.5,tooltipAxes:"x"},legend:{show:r,placement:l},series:g,axes:{xaxis:{labelRenderer:$.jqplot.CanvasAxisLabelRenderer,label:h,formatString:"%.2f",min:0,tickRenderer:$.jqplot.CanvasAxisTickRenderer,tickOptions:{angle:a}},yaxis:{labelRenderer:$.jqplot.CanvasAxisLabelRenderer,label:o,tickRenderer:$.jqplot.CanvasAxisTickRenderer,ticks:e.series[0].x,renderer:$.jqplot.CategoryAxisRenderer}},axesDefaults:{pad:1.4}};break;case"barchart":p={stackSeries:false,seriesDefaults:{renderer:$.jqplot.BarRenderer,rendererOptions:{barMargin:30,highlightMouseDown:true},pointLabels:{show:d}},highlighter:{show:!d,sizeAdjust:7.5,tooltipAxes:"y"},legend:{show:r,placement:l},series:g,axes:{xaxis:{renderer:$.jqplot.CategoryAxisRenderer,ticks:e.series[0].x,label:h,labelRenderer:$.jqplot.CanvasAxisLabelRenderer,tickRenderer:$.jqplot.CanvasAxisTickRenderer,tickOptions:{angle:a}},yaxis:{label:o,labelRenderer:$.jqplot.CanvasAxisLabelRenderer,formatString:"%.2f",min:0}},axesDefaults:{pad:1.4}};break;case"table":var q=$("<table>").addClass("tablevis");var s=$("<tr>");if(g.length==1){s.append("<td class='caption' colspan='2' rowspan='2'>&nbsp;</td>")}else{s.append("<td class='caption' colspan='2'>&nbsp;</td>")}s.append("<td class='caption' colspan='"+e.series[0].x.length+"'>"+h+"</td>");s.appendTo(q);var s=$("<tr>");if(g.length>1){s.append("<td class='caption'>"+c+"</td>");s.append("<td class='caption'>"+o+"</td>")}for(j=0;j<e.series[0].x.length;j++){s.append("<th>"+e.series[0].x[j]+"</th>")}s.appendTo(q);for(k=0;k<e.series.length;k++){for(i=0;i<e.series[0].y.length;i++){var s=$("<tr>");for(j=-1;j<e.series[0].x.length;j++){if(j<0){if(i==0){if(g.length==1){s.append("<td class='caption' rowspan='"+e.series[0].y.length+"'>"+o+"</td>")}else{s.append("<td class='caption' rowspan='"+e.series[0].y.length+"'>"+e.series[k].name+"</td>")}}s.append("<th>"+e.series[k].y[i]+"</th>")}else{s.append("<td>"+e.series[k].data[j][i]+"</td>")}}s.appendTo(q)}}p=q;break;case"boxplot":n=[n];p={series:[{renderer:$.jqplot.BoxplotRenderer,rendererOptions:{}}],highlighter:{show:true,sizeAdjust:7.5,showMarker:true,tooltipAxes:"y",yvalues:8,formatString:'<table class="jqplot-highlighter dummy%s"><tr><td>Maximum:</td><td>%s</td></tr><tr><td>Median + 1.5*IQR:</td><td>%s</td></tr><tr><td>Q3:</td><td>%s</td></tr><tr><td>Median:</td><td>%s</td></tr><tr><td>Q1:</td><td>%s</td></tr><tr><td>Median - 1.5*IQR:</td><td>%s</td></tr><tr><td>Minimum:</td><td>%s</td></tr></table>'},axesDefaults:{pad:1.4},axes:{xaxis:{renderer:$.jqplot.CategoryAxisRenderer,label:h,labelRenderer:$.jqplot.CanvasAxisLabelRenderer,tickRenderer:$.jqplot.CanvasAxisTickRenderer,tickOptions:{angle:a}},yaxis:{min:0}}};break}if(p!=null){$("#visualization").css("width",$("#visualization_container").innerWidth()-2);$("#visualization").css("height",$("#visualization_container").innerHeight()-2);$("#visualization").empty();if(e.type=="table"){$("#visualization").html(p)}else{visualization=$.jqplot("visualization",n,p)}$("#visualization").show()}$("#menu_go").find(".spinner").hide()}})}}function showError(b,c){for(index in b){var d=$("<div>").css("position","absolute").css("top","3px").css("right","10px").html("<a href='#' onclick='removeError(this); return false;'>x</a>");$("#message_container").prepend($("<div>").addClass("message_box "+c).html(b[index]).css("position","relative").fadeIn().append(d))}var a="&nbsp;"+$(".message_box").length+" message";if($(".message_box").length!=1){a=a+"s"}$("#messages_link").html(a)}function removeError(b){$(b).closest(".message_box").remove();var a="&nbsp;"+$(".message_box").length+" message";if($(".message_box").length!=1){a=a+"s"}$("#messages_link").html(a);if($(".message_box").length==0){$("#dialog_messages").dialog("close")}}function clearSelect(b,a){var c=$(b).parents(".menu_header").find(".block_variable");$(c).children("input, select").val("");$(c).children("input").data("autocomplete").term="";if(a==1){$(b).parents(".menu_item").children(".menu_header").each(function(d){if($(this).find("select").val()!=null&&$(this).find("select").val()!=""){clearSelect($(this).find("select"),0);$(this).find("select").empty();$(this).find("input").val("");$(this).children(".menu_header_count").removeClass().addClass("menu_header_count")}})}if(a>=1){$(b).parents(".menu_header").children(".menu_header_count").removeClass().addClass("menu_header_count menu_fill");visualize()}}function checkCorrectData(a){return("type" in a&&"xaxis" in a&&"yaxis" in a&&"series" in a&&$.isArray(a.series))}function gatherData(a){return $("#visualizationForm").serialize()}function executeAjaxCall(e,a,b){var d=gatherData(e);if(!b){b={}}if(b.errorMessage){var c=b.errorMessage;b.error=function(f,h,g){showError(["An error occurred while retrieving variables from the server. Please try again or contact a system administrator.<br />"+h],"message_error");$("#"+a).parents(".menu_header").find(".menu_header_count").switchClass("menu_fill","menu_error",1000);$("#"+a).parents(".menu_header").find("img.spinner").hide()};delete b.errorMessage}$.ajax($.extend({url:visualizationUrls[e],type:"POST",data:d,dataType:"json"},b))}(function(a){a.widget("ui.combobox",a.ui.autocomplete,{_create:function(){var d=this,b=this.element.hide(),e=b.children(":selected"),f=e.val()?e.text():"";var c=this.input=a("<input>").insertAfter(b).val(f).autocomplete({delay:0,minLength:0,source:function(h,g){var m=new RegExp(a.ui.autocomplete.escapeRegex(h.term),"i");var l="";g(b.find("option, optgroup").map(function(){if(this.nodeName=="OPTION"){var n=a(this).text();if(this.value&&((!h.term||m.test(n))||m.test(l))){return{category:l,label:n.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+a.ui.autocomplete.escapeRegex(h.term)+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>"),value:n,option:this}}}else{l=a(this).attr("label")}}))},select:function(g,h){h.item.option.selected=true;d._trigger("selected",g,{item:h.item.option});b.trigger("change")},change:function(h,l){if(!l.item){var m=new RegExp("^"+a.ui.autocomplete.escapeRegex(a(this).val())+"$","i"),g=false;b.children("option").each(function(){if(a(this).text().match(m)){this.selected=g=true;return false}});if(!g){a(this).val("");b.val("");c.data("autocomplete").term="";return false}}}});c.data("autocomplete")._renderMenu=function(m,l){var h=this,g="";a.each(l,function(n,o){if(o.category!=g){m.append("<li class='ui-autocomplete-category'>"+o.category+"</li>");g=o.category}h._renderItem(m,o)})};c.data("autocomplete")._renderItem=function(g,h){return a("<li></li>").data("item.autocomplete",h).append("<a>"+h.label+"</a>").appendTo(g)}},destroy:function(){this.input.remove();this.element.show();a.Widget.prototype.destroy.call(this)}})})(jQuery);